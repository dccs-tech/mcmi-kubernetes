parents:
  - module: cluster
    profile: aws-network

  - aws-domain
  - aws-config

domain:
  "@root_domain":
    certificate_authority: letsencrypt

certificate:
  kube:
    provider: aws
    network: "@aws_networks"
    domain: "@root_domain"
    groups: k8s-cluster

firewall:
  kubelet_internal:
    network: "@aws_networks"
    groups: k8s-cluster
    rules:
      kubelet_in:
        mode: ingress
        protocol: tcp
        from_port: "@kubelet_port"
        to_port: "@kubelet_port"
        cidrs: "&subnet.@aws_kube_master_subnets,@aws_kube_node_subnets.cidr"
      kubelet_ro_in:
        mode: ingress
        protocol: tcp
        from_port: "@kubelet_ro_port"
        to_port: "@kubelet_ro_port"
        cidrs: "&subnet.@aws_kube_master_subnets,@aws_kube_node_subnets.cidr"

  etcd_internal:
    network: "@aws_networks"
    groups:
      - etcd
      - k8s-cluster
    rules:
      tcp_in:
        mode: ingress
        protocol: tcp
        from_port: "@etcd_port_low"
        to_port: "@etcd_port_high"
        cidrs: "&subnet.@aws_kube_master_subnets.cidr"

  weave_internal:
    network: "@aws_networks"
    groups:
      - weave
      - k8s-cluster
    rules:
      tcp_in:
        mode: ingress
        protocol: tcp
        from_port: "@weave_port_low"
        to_port: "@weave_port_high"
        cidrs: "&subnet.@aws_kube_master_subnets,@aws_kube_node_subnets.cidr"

provision:
  credentials:
    command: server rotate

  kubernetes:
    requires: credentials
    task: cluster
    cluster_name: "@kube_cluster_name"
    admin_user: "@aws_ubuntu_user"
    ssh_allow_users: "@aws_ubuntu_user"
    kube_service_addresses: "@kube_service_addresses"
    kube_pods_subnet: "@kube_pods_subnet"
    kube_api_domain: "kube.@root_domain"
